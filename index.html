<!DOCTYPE html>
<html lang="hu">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>N√∂v√©nyfigyel≈ë</title>

  <!-- OneSignal SDK -->
  <script src="https://cdn.onesignal.com/sdks/web/v16/OneSignalSDK.page.js" defer></script>
  <script>
    window.OneSignalDeferred = window.OneSignalDeferred || [];
    OneSignalDeferred.push(async function(OneSignal) {
      await OneSignal.init({
        appId: "9083ca92-fe8b-460c-8591-3430a5a17fb2",
      });

      // Amikor a felhaszn√°l√≥ enged√©lyezi a push √©rtes√≠t√©st, elmentj√ºk a player ID-t
      OneSignal.on('subscriptionChange', function (isSubscribed) {
        if (isSubscribed) {
          OneSignal.getUserId(function(playerId) {
            console.log("OneSignal Player ID:", playerId);
            // Elmentj√ºk a playerId-t a Firebase-be csak ha be van jelentkezve a user
            if(window.firebaseUser && playerId) {
              const db = window.firebaseDatabase;
              const userId = window.firebaseUser.uid;
              const updates = {};
              updates['/users/' + userId + '/oneSignalPlayerId'] = playerId;
              db.ref().update(updates);
              console.log("Player ID elmentve a Firebase-be");
            }
          });
        }
      });
    });
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
    import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyCfo3UqEb77ihYOqSJZvIFVr2VRGf6dJ4w",
      authDomain: "plant-monitor-3976f.firebaseapp.com",
      databaseURL: "https://plant-monitor-3976f-default-rtdb.europe-west1.firebasedatabase.app",
      projectId: "plant-monitor-3976f",
      storageBucket: "plant-monitor-3976f.firebasestorage.app",
      messagingSenderId: "705425147510",
      appId: "1:705425147510:web:71f15bde879f3672df8157",
      measurementId: "G-890H6FDBYE"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getDatabase(app);

    // T√°roljuk glob√°lisan k√©s≈ëbbi haszn√°latra (OneSignal player ID ment√©s miatt)
    window.firebaseDatabase = db;

    const loginForm = document.getElementById("loginForm");
    const emailInput = document.getElementById("email");
    const passInput = document.getElementById("password");
    const statusDiv = document.getElementById("status");
    const gaugeValue = document.getElementById("gauge-value");
    const gaugeCircle = document.querySelector(".gauge-fill");
    const logoutBtn = document.getElementById("logout");

    const RADIUS = 80;
    const CIRCUMFERENCE = 2 * Math.PI * RADIUS;

    gaugeCircle.style.strokeDasharray = CIRCUMFERENCE;

    loginForm.addEventListener("submit", (e) => {
      e.preventDefault();
      signInWithEmailAndPassword(auth, emailInput.value, passInput.value)
        .catch((error) => { statusDiv.innerText = "Hiba: " + error.message; });
    });

    onAuthStateChanged(auth, (user) => {
      if (user) {
        statusDiv.innerText = `Bejelentkezve: ${user.email}`;
        loginForm.style.display = "none";
        logoutBtn.style.display = "block";

        // Mentj√ºk glob√°lisan a bel√©pett usert a playerId ment√©shez
        window.firebaseUser = user;

        const soilMoistureRef = ref(db, `users/${user.uid}/devices/esp32_001/sensorValue`);
        onValue(soilMoistureRef, (snapshot) => {
          if (snapshot.exists()) {
            const soilMoisture = snapshot.val();
            updateGauge(soilMoisture);

            if (soilMoisture < 35) {
              alert('A n√∂v√©ny szomjas! Locsold meg! üå±üíß');
            }
          }
        });

      } else {
        statusDiv.innerText = "Nincs bejelentkezve";
        loginForm.style.display = "block";
        logoutBtn.style.display = "none";
        updateGauge(0);

        // Kil√©p√©s ut√°n t√∂r√∂lj√ºk a glob√°lis user adatot is
        window.firebaseUser = null;
      }
    });

    logoutBtn.addEventListener("click", () => {
      signOut(auth);
    });

    function updateGauge(value) {
      gaugeValue.innerText = value + "%";
      const offset = CIRCUMFERENCE - (value / 100) * CIRCUMFERENCE;
      gaugeCircle.style.strokeDashoffset = offset;

      const color = getGradientColor(value);
      gaugeCircle.style.stroke = color;
      gaugeValue.style.color = color;
    }

    function getGradientColor(value) {
      let r, g, b;
      if (value <= 50) {
        const ratio = value / 50;
        r = 255;
        g = Math.round(69 + (215 - 69) * ratio);
        b = 0;
      } else {
        const ratio = (value - 50) / 50;
        r = Math.round(255 + (76 - 255) * ratio);
        g = Math.round(215 + (175 - 215) * ratio);
        b = Math.round(0 + (80 - 0) * ratio);
      }
      return `rgb(${r},${g},${b})`;
    }
  </script>

  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f8ff;
      text-align: center;
      padding: 20px;
    }
    .card {
      background: white;
      border-radius: 15px;
      padding: 20px;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
      margin: 20px auto;
      max-width: 400px;
    }
    input {
      width: 80%;
      padding: 10px;
      margin: 10px 0;
      border-radius: 10px;
      border: 1px solid #ccc;
    }
    button {
      padding: 10px 20px;
      border-radius: 10px;
      border: none;
      background: #4CAF50;
      color: white;
      cursor: pointer;
    }
    #logout { display: none; margin-top: 20px; }
    #plantData { display: block; }

    .gauge-container {
      position: relative;
      width: 200px;
      height: 200px;
      margin: 20px auto;
    }
    .gauge-svg {
      transform: rotate(-90deg);
    }
    .gauge-bg {
      fill: none;
      stroke: #eee;
      stroke-width: 15;
    }
    .gauge-fill {
      fill: none;
      stroke-width: 15;
      stroke-linecap: round;
      stroke-dasharray: 0;
      stroke-dashoffset: 0;
      transition: stroke-dashoffset 0.5s ease, stroke 0.3s ease;
    }
    .gauge-value {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      font-size: 28px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>N√∂v√©nyfigyel≈ë üå±</h1>

  <div class="card">
    <form id="loginForm">
      <h3>Bejelentkez√©s</h3>
      <input type="email" id="email" placeholder="Email" required /><br />
      <input type="password" id="password" placeholder="Jelsz√≥" required /><br />
      <button type="submit">Bel√©p√©s</button>
    </form>

    <button id="logout">Kijelentkez√©s</button>
    <p id="status">Nincs bejelentkezve</p>
  </div>

  <div class="card" id="plantData">
    <div class="gauge-container">
      <svg class="gauge-svg" width="200" height="200" viewBox="0 0 200 200">
        <circle class="gauge-bg" cx="100" cy="100" r="80"></circle>
        <circle class="gauge-fill" cx="100" cy="100" r="80"></circle>
      </svg>
      <div class="gauge-value" id="gauge-value">0%</div>
    </div>
  </div>
</body>
</html>
